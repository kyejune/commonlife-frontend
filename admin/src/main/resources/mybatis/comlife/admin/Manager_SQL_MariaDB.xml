<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Manager">
    <select id="selectLoginManager" parameterType="managerInfo" resultType="managerInfo">
        /* Manager 로그인 조회 */
        DECLARE @MNG_ID VARCHAR(100) SET @MNG_ID = #{mngId}
        DECLARE @MNG_PW VARCHAR(100) SET @MNG_PW = #{mngPw}

        SELECT
            MNG_ID, MNG_NM, MNG_EMAIL, USE_YN,
            BIGO, REG_DTTM, REG_USERID, UPD_DTTM, UPD_USERID
        FROM MANAGER_INFO WITH(NOLOCK)
        WHERE MNG_ID = @MNG_ID
          AND MNG_PW = HASHBYTES('SHA2_256', @MNG_PW)
          AND USE_YN = 'Y'

    </select>

    <select id="selectManagerList" parameterType="adminInfo" resultType="adminInfo">
        /* 관리자 리스트 조회 */

        <include refid="Common.prefixPagination"/>
        SELECT
          `ADMIN_IDX`,
          `ADMIN_ID`,
          `ADMIN_NM`,
          `ADMIN_EMAIL`,
          `USE_YN`,
          `DESC`,
          `REG_DTTM`,
          `REG_ADMIN_IDX`,
          `UPD_DTTM`,
          `UPD_ADMIN_IDX`,
          `CMPLX_ID`,
          ROW_NUMBER() OVER(ORDER BY ADMIN_ID ASC) ROWNUM,
          COUNT(1) OVER() AS TOT
        FROM(
            SELECT
                `ADMIN_IDX`,
                `ADMIN_ID`,
                `ADMIN_NM`,
                `ADMIN_EMAIL`,
                `USE_YN`,
                `DESC`,
                `REG_DTTM`,
                `REG_ADMIN_IDX`,
                `UPD_DTTM`,
                `UPD_ADMIN_IDX`,
                `CMPLX_ID`
            FROM
                CL_ADMIN_INFO AS A_I
            WHERE 1=1
            <choose>
                <when test='searchType1 != null and searchType1.equals("ADMIN_ID")'>
                    AND ADMIN_ID LIKE CONCAT('%', #{searchKeyword1}, '%')
                </when>
                <when test='searchType1 != null and searchType1.equals("ADMIN_NM")'>
                    AND ADMIN_NM LIKE CONCAT('%', #{searchKeyword1}, '%')
                </when>
                <otherwise>
                    AND (ADMIN_ID LIKE CONCAT('%', #{searchKeyword1}, '%') OR ADMIN_NM LIKE CONCAT('%', #{searchKeyword1}, '%'))
                </otherwise>
            </choose>
        )A
        <include refid="Common.orderby"/>
        <include refid="Common.suffixPagination"/>
    </select>


    <select id="selectManagerDetail" parameterType="adminInfo" resultType="adminInfo">
        /* 관리자 상세 조회 */
        SELECT
          `ADMIN_IDX`,
          `ADMIN_ID`,
          `ADMIN_NM`,
          `ADMIN_EMAIL`,
          `USE_YN`,
          A_I.`DESC`,
          A_I.`REG_DTTM`,
          A_I.`REG_ADMIN_IDX`,
          A_I.`UPD_DTTM`,
          A_I.`UPD_ADMIN_IDX`,
          A_I.`CMPLX_ID`,
          (SELECT CMPLX_NM FROM COMPLEX_M WHERE CMPLX_ID = A_I.CMPLX_ID) AS `CMPLX_NM`,
          A_G.`GRP_ID` AS `GRP_ID`,
          A_G.`GRP_NM` AS `GRP_NM`
        FROM
          CL_ADMIN_INFO AS A_I,
          CL_ADMIN_GRP AS A_G
        WHERE
          A_I.GRP_ID = A_G.GRP_ID
            AND
          ADMIN_ID = '${adminId}'
    </select>

    <insert id="insertManager" parameterType="managerInfo">
        DECLARE @MNG_ID VARCHAR(100) SET @MNG_ID = #{mngId}
        DECLARE @MNG_PW VARCHAR(100) SET @MNG_PW = #{mngPw}

        /* 관리자 등록 */
        INSERT INTO MANAGER_INFO(MNG_ID,
                                 MNG_PW,
                                 MNG_NM,
                                 MNG_EMAIL,
                                 USE_YN,
				    	         BIGO,
				    	         REG_DTTM,
				    	         REG_USERID,
				    	         UPD_DTTM,
				    	         UPD_USERID)
        VALUES(@MNG_ID,
               HASHBYTES('SHA2_256', @MNG_PW),
               #{mngNm},
               #{mngEmail},
               #{useYn},
               #{bigo},
               CONVERT(DATETIME, GETDATE(), 121),
               #{regUserId},
               CONVERT(DATETIME, GETDATE(), 121),
               #{updUserId})
    </insert>

    <update id="updateManager" parameterType="managerInfo">
        /* 관리자 수정 */
        <![CDATA[
        DECLARE @MNG_PW VARCHAR(100) SET @MNG_PW = #{mngPw}

        UPDATE MANAGER_INFO SET
        ]]>

        <if test='mngPw != null and !mngPw.equals("")'>
            MNG_PW = HASHBYTES('SHA2_256' , @MNG_PW),
        </if>

        <if test='mngNm != null and !mngNm.equals("")'>
            MNG_NM = #{mngNm},
        </if>

        <if test='mngEmail != null and !mngEmail.equals("")'>
            MNG_EMAIL = #{mngEmail},
        </if>

        <if test='bigo != null and !bigo.equals("")'>
            BIGO = #{bigo},
        </if>

        <if test='useYn != null and !useYn.equals("")'>
            USE_YN = #{useYn},
        </if>

        <![CDATA[
            UPD_DTTM = CONVERT(DATETIME, GETDATE(), 121),
            UPD_USERID = #{updUserId}
        WHERE MNG_ID = #{mngId}
        ]]>
    </update>
</mapper>