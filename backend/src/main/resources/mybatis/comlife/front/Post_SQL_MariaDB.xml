<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Post">

    <select id="countPostList" resultType="java.lang.Integer">
    <![CDATA[
        SELECT
                COUNT( * ) as COUNT
        FROM
                `POST`
    ]]>
    </select>

    <select id="selectPostList" parameterType="java.util.Map" resultType="postInfo">
        SELECT *  FROM (
            SELECT
                `POST`.*,
                SUM(CASE WHEN ISNULL(`LIKE`.`LIKE_IDX`) THEN 0 ELSE 1 END) AS LIKES_COUNT,
                IF( 1 = SUM(CASE WHEN `LIKE`.`USR_ID` = #{usrId} THEN 1 ELSE 0 END), TRUE, FALSE) AS MY_LIKE_FLAG
            FROM
              `POST`
                LEFT JOIN
              `LIKE`
                ON  `POST`.`POST_IDX` = `LIKE`.`PARENT_IDX`  AND `LIKE`.`DEL_YN` = "N"
            WHERE
                `POST`.`DEL_YN` = 'N'
                <if test="cmplxId != null">
                  AND CMPLX_ID=#{cmplxId}
                </if>
            GROUP BY POST_IDX ) AS POST_LIST
        ORDER BY
            POST_IDX DESC -- 생성기준, 역순으로 표시
        LIMIT
            #{limit}
        OFFSET
            #{offset}
    </select>

    <select id="selectPost" parameterType="java.util.Map" resultType="postInfo">
    <![CDATA[
        SELECT
                *
        FROM
                `POST`
        WHERE
                `DEL_YN` = 'N'
                AND
                `POST_IDX` = #{postIdx}
    ]]>
    </select>

    <select id="selectLatestPost" resultType="postInfo">
    <![CDATA[
        SELECT
                *
        FROM
                `POST`
        WHERE
                `DEL_YN` = 'N'
                AND
                `POST_IDX` = LAST_INSERT_ID()
    ]]>
    </select>

    <insert id="insertPost" parameterType="postInfo">
    <![CDATA[
        INSERT
        INTO    `POST`
        (
            `POST_TYPE`,
            `CONTENT`,
            `USR_ID`,
            `CMPLX_ID`,
            `REG_DTTM`,
            `UPD_DTTM`
        )
        VALUES
        (
            #{postType},
            #{content},
            #{usrId},
            #{cmplxId},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    ]]>
    </insert>

    <update id="updatePost" parameterType="postInfo">
    <![CDATA[
        UPDATE  `POST`
        SET     `POST_TYPE` = #{postType},
                `CONTENT`   = #{content},
                `UPD_DTTM`  = CURRENT_TIMESTAMP
        WHERE
                `DEL_YN`   = 'N'  AND
                `POST_IDX` = #{postIdx} AND
                `USR_ID`   = #{usrId}
    ]]>
    </update>

    <update id="deletePost" parameterType="postInfo">
    <![CDATA[
        UPDATE  `POST`
        SET     `DEL_YN`   = 'Y',
                `UPD_DTTM` = CURRENT_TIMESTAMP
        WHERE
                `DEL_YN`   = 'N'  AND
                `POST_IDX` = #{postIdx} AND
                `USR_ID`   = #{usrId}
    ]]>
    </update>

</mapper>